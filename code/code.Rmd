title: "Bil code"
author: "Thomas Holm-Weber"
date: "2023-03-28"
output: html_document
---

#Packagesinstall
```{r, echo=FALSE}
---
install.packages("tidyverse", repos = "http://cran.us.r-project.org")
install.packages("kableExtra")
install.packages("knitr")
```
#PackagesLibrary
```{r, echo=FALSE}
library(tidyverse)
library(ggplot2)
library(dplyr)
library(kableExtra)
library(knitr)
```


#Data Import Mac
```{r, echo=FALSE}
getwd()
setwd("/Users/thomasholm-weber/Desktop/bil/bil2/data")
bil = read_csv("bil.csv")
```

#Data Import PC
```{r}
getwd()
setwd("H:/PhD RH 2019 - 2022/Prj 4 BILACO/rbil/bil2/data")
bil = read_csv("bil.csv")
```

#Subsets disease & rename variables
```{r, echo=FALSE}
bil$disease = recode(bil$disease, "1" = "ba", "2" = "tof", "3" = "cc")
bil$mm_for_estimation_of_cvp = recode(bil$mm_for_estimation_of_cvp, "1" = "Normal")
bil$color_for_evaluation_of_ar = recode(bil$color_for_evaluation_of_ar, "1" = "No Aortic Regurgitation")
bil$pr = recode(bil$color_for_estimation_of_pr, "1" = "None", "2" = "Mild", "3" = "Moderat ", "4" = "Severe")
bil$mv_color_interrogation_for = recode(bil$mv_color_interrogation_for, "1" = "No Mitral Valve Regurgitation", "2" = "Mild Mitral Valve Regurgitation")
bil$congenital_anatomy = recode(bil$congenital_anatomy, "1" = "ToF", "2" = "ToF w/ PA", "3" = "ToF w/ near PA", "4" = "ToF w/ PA and MAPCA supply")
bil$sex = recode(bil$sex, "1" = "M", "2" = "F")
bil$shunt = recode(bil$shunt, "1" = "Yes", "2" = "No")
bil$pink_or_blue = recode(bil$pink_or_blue, "1" = "Pink", "2" = "Blue")
bil$sat_newborn = recode(bil$sat_newborn, "1" = "96-100", "2" = "91-95", "3" = "86-90", "4" = "81-85", "5" =  "76-80", "6" = "70-75", "7" = "< 70", "8" = "NA")
bil$prolonged_pleura_effusion = recode(bil$prolonged_pleura_effusion, "1" = "Yes", "2" = "No")
bil$td_tortousity_asfac = recode(bil$td_tortousity, "1" = "None", "2" = "Mild", "3" = "Moderate", "4" = "Severe")

##lrate_diff
bil$lrate_diff = bil$lrate - bil$lrate_2

##rname cols
bil = bil %>% rename(
    ID = fp_nr,
    Type = mritype_agreed,
    "Rate 1" = lrate,
    "Rate 2" = lrate_2,
    Pressure = lpressure,
    PR = pr,
    IVC = mm_for_estimation_of_cvp,
    TAPSE = mm_lateral_tv_annulus_for,
    "PR (years)" = years_with_pr,
    EF = ef
)

ba = bil %>% filter(disease=="ba")
tof = bil %>% filter(disease=="tof")  %>% slice(-8)
cc = bil %>% filter(disease=="cc")

tof$ID = recode(tof$ID,
                   "9" = "A", 
                   "13" = "B", 
                   "14" = "C", 
                   "15" = "D", 
                   "16" = "E", 
                   "17" = "F", 
                   "18" = "G",
                   "19" = "H", 
                   "24" = "I")

```


#ToF baseline data
```{r}
##Table 1

toft1 <- tof %>% 
  select(ID,
         age_at_doi,
         sex,
         bmi,
         c(61:63)
         ) %>% arrange(ID)

toft1 = toft1 %>% 
  rename(
    "Age (years)" = age_at_doi,
    BMI = bmi,
    Sex = sex,
    "Heart Rate" = puls,
    "Systolic" = bt_sys,
    "Diastolic" = bt_dia)


tof1latex = kbl(toft1, "latex",
    booktabs = T, 
    digits = 1, 
    caption = "Baseline Demographic data",
    linesep = "",
    escape = FALSE) %>%
  kable_classic_2 %>%
  kable_styling(position = "center") %>%
  add_header_above(c(" " = 4, "Blood pressure" = 2))

cat(tof1latex)

##Surgical hx


tofhx = tof %>% 
  select(ID,
         congenital_anatomy,
         sat_newborn,
         shunt_in_months,
         age_at_repair_months,
         repair_type, 
         "PR (years)") %>% arrange(ID)

tofhx = tofhx %>% 
  rename(
    Anatomy = congenital_anatomy,
    "SAT" = sat_newborn,
    "Shunt (Months)" = shunt_in_months,
    "Age (Months)" = age_at_repair_months,
    "Type" = repair_type
  )


tofhxlatex = kbl(tofhx, "latex",
    booktabs = T, 
    digits = 1, 
    caption = "Surgical History",
    linesep = "",
    escape = FALSE) %>%
  kable_classic_2 %>%
  add_header_above(c(" " = 1, "Neonatal" = 3, "Repair" = 2)) %>%
  kable_styling(position = "center")

cat(tofhxlatex)

```
#MRI3
```{r}
mr3 = tof %>% filter(Type=="3")

mr3t = mr3 %>%
  select(ID,
         congenital_anatomy,
         sat_newborn,
         shunt_in_months,
         age_at_repair_months,
         repair_type,
         prolonged_pleura_effusion,
         `Years with PR`) %>% arrange(ID)

mr3t = mr3t %>% 
  rename(
    "Anatomy" = congenital_anatomy,
    "SAT" = sat_newborn,
    "Shunt (Months)" = shunt_in_months,
    "Age (Months)" = age_at_repair_months,
    "Type" = repair_type,
    "PE or RV failure PO" = prolonged_pleura_effusion,
    "PR (Years)" = `Years with PR`
  )


mr3t = kbl(mr3t, "latex",
    booktabs = T, 
    digits = 1, 
    caption = "MRI type 3 characteristics",
    linesep = "",
    escape = FALSE) %>%
  kable_classic_2 %>%
  add_header_above(c(" " = 1, "Neonatal" = 3, "Repair" = 3)) %>%
  kable_styling(position = "center")

cat(mr3t)
```




#NIRF ToF
```{r}
mean(tof$lrate, na.rm = T)
sd(tof$lrate, na.rm = T)
mean(tof$lrate_2, na.rm = T)
sd(tof$lrate_2, na.rm = T)
mean(tof$lpressure, na.rm = T)
sd(tof$lpressure, na.rm = T)
```


#MR ToF
```{r, echo=FALSE}
mean(tof$mritype_agreed, na.rm = T)
```


#Boxplot LP
```{r, echo=FALSE}
ggplot(bil, aes(x = disease, y = lpressure)) +
  geom_boxplot() +
  labs(x = "disease", y = "lpressure") + theme_bw()

```


#Boxplot LR
```{r, echo=FALSE}
ggplot(bil, aes(x = disease, y = lrate)) +
  geom_boxplot() +
  labs(x = "disease", y = "lrate") + theme_bw()
```


#Boxplot LR2
```{r, echo=FALSE}
ggplot(bil, aes(x = disease, y = lrate_2)) +
  geom_boxplot() +
  labs(x = "disease", y = "lrate2") + theme_bw()

```


#ToFresultstableshort
```{r}
tofresults <- tof %>% 
  select(
    ID,
    Type,
    bil$td_tortousity_asfac,
    td_diameter,
    "Rate 1",
    "Rate 2",
    velo_1,
    velo_2,
    Pressure,
    PR,
    IVC,
    TAPSE,
    EF,
    "PR (years)"
  ) %>% arrange(ID)

tofresults = tofresults %>% 
  rename(
    "R1" = "Rate 1",
    "R2" = "Rate 2",
    "V1" = velo_1,
    "V2" = velo_2,
    "TD tortousity" = td_tortousity_asfac,
    "TD Diameter (mm)" = td_diameter)

tofresults

write.csv(tofresults, "tofresults.csv")

toflatex = kbl(tofresults, "latex",
    booktabs = T, 
    digits = 1, 
    caption = "Results",
    linesep = "",
    escape = FALSE) %>%
  kable_classic_2 %>%
  add_header_above(c(" " = 1, "MRI" = 3, "NIRF" = 5, "Echo" = 4)) %>%
  kable_styling(position = "center")


cat(toflatex)
```


#correlationstof
```{r}
## TD tortousity to MRI
correlationtdtmri <- tof %>%
  summarize(correlationtdtmri = cor(Type, td_tortousity, use = "complete.obs", method = "pearson"))

print(correlationtdtmri)

## TD diameter to MRIÂ¨
correlationtddmri <- tof %>%
  summarize(correlationtddmri = cor(Type, td_diameter, use = "complete.obs", method = "pearson"))

print(correlationtddmri)

## Lymph Rate to MRI
correlationlr1mri <- tof %>%
  summarize(correlationlr1mri = cor(Type, `Rate 1`, use = "complete.obs", method = "pearson"))

print(correlationlr1mri)

## Lymph Rate 2 to MRI
correlationlr2mri <- tof %>%
  summarize(correlationlr1mri = cor(Type, `Rate 2`, use = "complete.obs", method = "pearson"))

print(correlationlr2mri)

## Lymph Rate change to MRI
correlationlrdiffmri <- tof %>%
  summarize(correlationlr1mri = cor(Type, lrate_diff, use = "complete.obs", method = "pearson"))

print(correlationlrdiffmri)

## Lymph velocity 1 to MRI
correlationv1mri <- tof %>%
  summarize(correlationv1mri = cor(Type, velo_1, use = "complete.obs", method = "pearson"))

print(correlationv1mri)

## Lymph velocity 2 to MRI
correlationv2mri <- tof %>%
  summarize(correlationv2mri = cor(Type, velo_2, use = "complete.obs", method = "pearson"))

print(correlationv2mri)

## Lymph Pressure to MRI
correlationlpmri <- tof %>%
  summarize(correlationlpmri = cor(Type, Pressure, use = "complete.obs", method = "pearson"))

print(correlationlpmri)

## PR to MRI
correlationprmri <- tof %>%
  summarize(correlationpr1mri = cor(Type, color_for_estimation_of_pr, use = "complete.obs", method = "pearson"))

print(correlationprmri)

## Tapse to MRI
correlationtapsemri <- tof %>%
  summarize(correlationtapsemri = cor(Type, TAPSE, use = "complete.obs", method = "pearson"))

print(correlationtapsemri)

## Years PR to MRI
correlationyprmri <- tof %>%
  summarize(correlationyprmri = cor(Type, `PR (years)`, use = "complete.obs"), method = "pearson")

print(correlationyprmri)



```